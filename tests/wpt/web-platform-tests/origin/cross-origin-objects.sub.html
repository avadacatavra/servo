<!doctype html>
<meta charset=utf-8>
<meta name="timeout" content="long">
<title>Cross-origin behavior of Window and Location</title>
<link rel="author" title="Bobby Holley (:bholley)" href="bobbyholley@gmail.com">
<link rel="help" href="https://html.spec.whatwg.org/multipage/#security-window">
<link rel="help" href="https://html.spec.whatwg.org/multipage/#security-location">
<script src="/resources/testharness_xow.js"></script>
<script src="/resources/testharnessreport_xow.js"></script>
<div id=log></div>
<iframe id="B" src="blank.html"></iframe>
<iframe id="C" src="blank.html"></iframe>
<script>

function reloadSubframes(cb) {
  console.log("in reload");
  console.log(B);
  console.log(C);
  var iframes = document.getElementsByTagName('iframe');
  iframes.forEach = Array.prototype.forEach;
  var count = 0;
  function frameLoaded() {
    //console.log(this);
    //console.log(this.onload);
    this.onload = null;
    if (++count == iframes.length){
      console.log("all iframes are loaded");
      cb();
    }
  }
  iframes.forEach(function(ifr) { ifr.onload = frameLoaded; ifr.setAttribute('src', ifr.uriToLoad); });
}
function isObject(x) { return Object(x) === x; }


/*
 * Note: we eschew assert_equals in a lot of these tests, since the harness ends
 * up throwing when it tries to format a message involving a cross-origin object.
 */
//do the iframes reload. for each frame, set onload to function like frameloaded that incs and when all frames are loaded, do alladatest stuff
function reloadSubframes(cb) {
  console.log("in reload");
  console.log(B);
  console.log(C);
  var iframes = document.getElementsByTagName('iframe');
  iframes.forEach = Array.prototype.forEach;
  var count = 0;
  function frameLoaded() {
    console.log("frameloaded");
    console.log(this);
    console.log(this.onload);
    this.onload = null;
    if (++count == iframes.length){
      console.log("all frames loaded");
      cb();
    }
  }
  iframes.forEach(function(ifr) { ifr.onload = frameLoaded; ifr.setAttribute('src', ifr.uriToLoad); });
}
function isObject(x) { return Object(x) === x; }





//------------------------------------------------


/*
 * Setup boilerplate. This gives us a same-origin window "B" and a cross-origin
 * window "C".
 */
setup({explicit_done: true});
path = location.pathname.substring(0, location.pathname.lastIndexOf('/')) + '/frame.html';
console.log("death");
var B = document.getElementById('B');//.contentWindow;
console.log("meow");
console.log("B");
console.log(B);
var C = document.getElementById('C');//.contentWindow;
console.log("urgh");

var testList = [];
function addTest(fun, desc) { testList.push([fun, desc]); }


var iframes = document.getElementsByTagName('iframe');
iframes.forEach = Array.prototype.forEach;
var count = 0;
console.log(iframes.length);
console.log("B");
console.log(B);
function frameloaded() {
  console.log("frameloaded2");
  console.log(count);
  if (++count == iframes.length){
    console.log("all dat shit is loaded");
    
    console.log("B");
    console.log(B);
    console.log(B.contentWindow);
    Bw = B.contentWindow;
    Cw = C.contentWindow;

    Bw.frameElement.uriToLoad = path;  //still nulling out
    console.log("srsly");
    Cw.frameElement.uriToLoad = '//{{domains[www1]}}:' + location.port + path;
    console.log("bro");

    

    /*
     * Basic sanity testing.
     */

    addTest(function() {
      console.log("basic sanity checking");
      assert_equals(location.host, '{{domains[]}}:{{location[port]}}', 'Need to run the top-level test from {{domains[]}}:{{location[port]}}');
      console.log("0");
      assert_equals(Bw.parent, window, "window.parent works same-origin");
      console.log("1");
      console.log(Bw.parent==window);
      assert_equals(Cw.parent, window, "window.parent works cross-origin");
      console.log("2");
      console.log(Cw.parent, window);
      //assert_equals(Bw.location.pathname, path, "location.href works same-origin");
      console.log("3");
      console.log(Bw.location.pathname==path);  //FIXME false --> and this is failing silently
      //assert_throws(null, function() { Cw.location.pathname; }, "location.pathname throws cross-origin");
      console.log(Cw.location.pathname);    //FIXME this returns /origin/blank.html
      console.log("4");
      //assert_equals(Bw.frames, 'override', "Overrides visible in the same-origin case");
      console.log("5");
      console.log(Bw.frames);
      //assert_equals(Cw.frames, Cw, "Overrides invisible in the cross-origin case");
      console.log("6");
      console.log(Cw.frames);
    }, "Basic sanity-checking");

    console.log("before reload");
    reloadSubframes(runNextTest);
    console.log("after reload");
  }
  console.log("ergh");
}
iframes.forEach(function(ifr) { console.log("ifr"); console.log(ifr); ifr.onload = function(){console.log("sigh"); frameloaded();}});

// cross origin object identity preserved across document.domain
/*function doDocumentDomainTest(cb) {
  window.addEventListener('message', function onmessage(evt) {
    window.removeEventListener('message', onmessage);
    test(function() {
      var results = evt.data;
      assert_true(results.length > 0, 'Need results');
      results.forEach(function(r) { assert_true(r.pass, r.message); });
    }, "Cross-origin object identity preserved across document.domain");
    win.close();
    cb();
  });
  //var win = window.open('win-documentdomain.sub.html'); //FIXME we don't implement window.open #13241
}*/

// We do a fresh load of the subframes for each test to minimize side-effects.
// It would be nice to reload ourselves as well, but we can't do that without
// disrupting the test harness.
function runNextTest() {
  var entry = testList.shift();
  test(entry[0], entry[1]);
  if (testList.length != 0)
    reloadSubframes(runNextTest);
  else
    done();
    //doDocumentDomainTest(done); // Asynchronous.
}

</script>
