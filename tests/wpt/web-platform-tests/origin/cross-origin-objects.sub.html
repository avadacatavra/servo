<!doctype html>
<meta charset=utf-8>
<meta name="timeout" content="long">
<title>Cross-origin behavior of Window and Location</title>
<link rel="author" title="Bobby Holley (:bholley)" href="bobbyholley@gmail.com">
<link rel="help" href="https://html.spec.whatwg.org/multipage/#security-window">
<link rel="help" href="https://html.spec.whatwg.org/multipage/#security-location">
<script src="/resources/testharness_xow.js"></script>
<script src="/resources/testharnessreport_xow.js"></script>
<div id=log></div>
<iframe id="B"></iframe>
<iframe id="C"></iframe>
<script>

/*
 * Setup boilerplate. This gives us a same-origin window "B" and a cross-origin
 * window "C".
 */

setup({explicit_done: true});
path = location.pathname.substring(0, location.pathname.lastIndexOf('/')) + '/frame.html';

var x = new Promise(function(){});

var B = document.getElementById('B');//.contentWindow;
var bPromise = new Promise(function(resolve, reject) {
    console.log("bpromise");
    console.log(B);

    B = B.contentWindow;
    console.log("content window acquired");
    console.log(C);


    B.async = true;
    B.src = path;
    B.frameElement.uriToLoad = path;
    console.log(B);
    B.onload = resolve();
    B.onerror = reject(); 
    console.log("never gets here");
});

var C = document.getElementById('C'); //doing this messes with the location checks
var cPromise = new Promise(function(resolve, reject) {
    console.log("cpromise");
    console.log(C);
    
    C = C.contentWindow;
    console.log("content window acquired");
    console.log(C);

    //C.async = true;
    C.frameElement.uriToLoad = '//{{domains[www1]}}:' + location.port + path;
    console.log(C)
    C.onload = resolve();
    C.onerror = reject();
    console.log("never gets here"); 
});

console.log("wtf do i have");
console.log(B);
console.log(C);

function reloadSubframes(cb) {
  console.log("in reload");
  console.log(B);
  console.log(C);
  var iframes = document.getElementsByTagName('iframe');
  iframes.forEach = Array.prototype.forEach;
  var count = 0;
  function frameLoaded() {
    console.log(this);
    console.log(this.onload);
    this.onload = null;
    if (++count == iframes.length)
      cb();
  }
  iframes.forEach(function(ifr) { ifr.onload = frameLoaded; ifr.setAttribute('src', ifr.uriToLoad); });
}
function isObject(x) { return Object(x) === x; }


/*
 * Note: we eschew assert_equals in a lot of these tests, since the harness ends
 * up throwing when it tries to format a message involving a cross-origin object.
 */

var testList = [];
function addTest(fun, desc) { testList.push([fun, desc]); }

/*
 * Basic sanity testing.
 */

addTest(function() {
  console.log("basic sanity checking");
  assert_equals(location.host, '{{domains[]}}:{{location[port]}}', 'Need to run the top-level test from {{domains[]}}:{{location[port]}}');
  assert_equals(B.parent, window, "window.parent works same-origin");
  assert_equals(C.parent, window, "window.parent works cross-origin");
  assert_equals(B.location.pathname, path, "location.href works same-origin");
  assert_throws(null, function() { C.location.pathname; }, "location.pathname throws cross-origin");
  assert_equals(B.frames, 'override', "Overrides visible in the same-origin case");
  assert_equals(C.frames, C, "Overrides invisible in the cross-origin case");
}, "Basic sanity-checking");

function doDocumentDomainTest(cb) {
  window.addEventListener('message', function onmessage(evt) {
    window.removeEventListener('message', onmessage);
    test(function() {
      var results = evt.data;
      assert_true(results.length > 0, 'Need results');
      results.forEach(function(r) { assert_true(r.pass, r.message); });
    }, "Cross-origin object identity preserved across document.domain");
    win.close();
    cb();
  });
  var win = window.open('win-documentdomain.sub.html');
}


// We do a fresh load of the subframes for each test to minimize side-effects.
// It would be nice to reload ourselves as well, but we can't do that without
// disrupting the test harness.
function runNextTest() {
  var entry = testList.shift();
  test(entry[0], entry[1]);
  if (testList.length != 0)
    reloadSubframes(runNextTest);
  else
    doDocumentDomainTest(done); // Asynchronous.
}
console.log("before reload");
Promise.all([bPromise, cPromise]).then(function() { console.log("promise all"); reloadSubframes(runNextTest) });
console.log("the end");
console.log(B);
console.log(bPromise);
console.log(C);

</script>
